- name: Bootstrap Kubernetes cluster
  hosts: k8s_all
  become: true
  vars_files:
    - vars.yml
  tasks:
    - name: Install prerequisites on all nodes
      include_tasks: tasks/install_prereqs.yml

- name: Initialize control-plane
  hosts: k8s_control[0]
  become: true
  tasks:
    - name: Initialize kubeadm (first control plane)
      include_tasks: tasks/init_control.yml

- name: Join remaining control-plane nodes
  hosts: k8s_control[1:]
  become: true
  tasks:
    - name: Join control-plane
      include_tasks: tasks/join_control.yml

- name: Join workers
  hosts: k8s_workers
  become: true
  tasks:
    - name: Join worker node
      include_tasks: tasks/join_worker.yml

- name: Deploy cluster addons
  hosts: k8s_control[0]
  become: true
  tasks:
    - name: Deploy MetalLB
      include_tasks: tasks/deploy_metallb.yml

    - name: Deploy NGINX ingress
      include_tasks: tasks/deploy_ingress.yml

    - name: Deploy hello-world app
      include_tasks: tasks/deploy_hello.yml
