# Controller-rendered conservative nftables template for Proxmox management
# NOTE: Always invoke ansible with escaped double-quoted extra-vars:
# --extra-vars "proxmox_node_ips=[\"192.168.10.201\",\"192.168.10.202\"] admin_allowed_ips=[\"192.168.10.211\",\"192.168.10.10\"]"

# Defensive coercion: ensure inputs are lists even if passed as YAML strings
{% set node_list = (proxmox_node_ips if (proxmox_node_ips is iterable and proxmox_node_ips is not string) else (proxmox_node_ips | default('[]') | from_yaml)) %}
{% set admin_list = (admin_allowed_ips if (admin_allowed_ips is iterable and admin_allowed_ips is not string) else (admin_allowed_ips | default('[]') | from_yaml)) %}

table inet proxmox_mgmt {
  chain input {
    type filter hook input priority 0; policy accept;

    # allow loopback and established
    iif lo accept
    ct state established,related accept

    # Explicit per-node corosync accepts (one rule per IP per port)
    {% for ip in node_list %}
    # corosync from {{ ip }}
    ip saddr {{ ip }} udp dport 5404 accept
    ip saddr {{ ip }} udp dport 5405 accept
    {% endfor %}

    # Explicit per-admin accepts for management ports (one rule per IP per port)
    {% for admin_ip in admin_list %}
    # admin access from {{ admin_ip }}
    ip saddr {{ admin_ip }} tcp dport 22 accept
    ip saddr {{ admin_ip }} tcp dport 8006 accept
    # storage control ports (NFS/iSCSI) if used
    ip saddr {{ admin_ip }} tcp dport 2049 accept
    ip saddr {{ admin_ip }} tcp dport 3260 accept
    {% endfor %}

    # Drop any other source attempting management ports
    tcp dport 22 counter drop
    tcp dport 8006 counter drop
    udp dport 5404 counter drop
    udp dport 5405 counter drop
  }
}
